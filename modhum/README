# Download modern human genomes from Altai website. After download, 
# I moved them all into directory modhum.
wget -r --no-parent -A "SS*.hg19_1000g.*.mod.vcf.*" \
http://cdna.eva.mpg.de/neandertal/altai/ModernHumans/vcf/

# Getting this error from bcftools:
    [W::vcf_parse] FILTER 'LowQual' is not defined in the header

# To fix this problem, I'm using the altai.sed and doaltai.sh scripts,
# which are documented in the orig directory. For this run, I modified 
# so that the output is compressed using bgzip.

    ls *.mod.vcf.gz | xargs -P 10 -n 1 bash doaltai.sh

# After running this, I have files with names like xxx-fixed.vcf.bgz, which bcftools
# will read without reporting errors.

# Remove originals
    rm *.mod.vcf.gz *.mod.vcf.gz.tbi

# List of autosome files
    ls *.vcf.bgz | grep -v X | grep -v MT | grep -v Y | grep -v nonchrom > autosomes

# Index
cat autosomes | xargs -P 15 -n 1 tabix

# filter
cat autosomes | tr ".-" " " | awk '{print $1, $3}' | sort -k1 -k2 \
 | xargs -P 15 -n 2 bash filter.sh

# Create a list of sequence ids
ls *fixed*.bgz | tr "." "\t" | cut -f1 | sort | uniq > seqid

# Concatenate autosomes for each sequence
cat seqid | xargs -P 24 -n 1 bash concat.sh

# Change names of files to reflect populations
mv SS6004467_autosomes.bcf dai_autosomes.bcf
mv SS6004468_autosomes.bcf french_autosomes.bcf
mv SS6004469_autosomes.bcf han_autosomes.bcf
mv SS6004470_autosomes.bcf mandenka_autosomes.bcf
mv SS6004471_autosomes.bcf mbuti_autosomes.bcf
mv SS6004472_autosomes.bcf papuan_autosomes.bcf
mv SS6004473_autosomes.bcf san_autosomes.bcf
mv SS6004474_autosomes.bcf sardinian_autosomes.bcf
mv SS6004475_autosomes.bcf yoruba_autosomes.bcf
mv SS6004476_autosomes.bcf karitiana_autosomes.bcf
mv SS6004479_autosomes.bcf mixe_autosomes.bcf
mv SS6004480_autosomes.bcf dinka_autosomes.bcf

# Errors:
# mv: cannot stat 'SS6004479_autosomes.bcf': No such file or directory
# mv: cannot stat 'SS6004480_autosomes.bcf': No such file or directory
# Perhaps the download failed for these files.

# Index the two australian sequences
echo SS6004477_autosomes.bcf SS6004478_autosomes.bcf | xargs -P 2 -n 1 tabix

# Merge the two Australian sequences into a single bcf file.
bcftools merge --output australia_autosomes.bcf \
  --output-type b \
  SS6004477_autosomes.bcf SS6004478_autosomes.bcf

# Remove the single-sequence Australian files
rm SS6004477_autosomes.bcf SS6004478_autosomes.bcf

# Generate data for analysis.
ls *_autosomes.bcf | xargs -P 11 -n 1 bash mkdaf.sh

# Problem: With multiple files, tabpat tabulates only 40k SNPs. Yet
# each of the .daf files has around 2e6 lines. This suggests that the
# SNPs in the various files are largely distinct, with only a minority
# of lines held in common. Am I somehow excluding SNPs that are
# monomorphic in a given population?