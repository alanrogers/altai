# Download modern human genomes from Altai website

    sbatch download.slr

# Concatenate Neanderthal autosomes
    bcftools concat --file-list autosomes --threads 20 --output-type b --output AltaiNea.bcf

############################ OLD #######################################


# Getting two errors from bcftools:
    [W::vcf_parse] FILTER 'LowQual' is not defined in the header
	[W::vcf_parse] INFO '.' is not defined in the header, assuming Type=String
# Searching the web, I found example of vcf files containing a LowQual definition in 
# the header. To find the cause of the 2nd error, I looked at the output lines surrounding 
# the error:
	bcftools view AltaiNea.hg19_1000g.22.mod.vcf.gz 2>&1 | grep -C 20 "not defined"
# A few lines after the error, I found this:
	22      18685734        .       C       .       .       .       .;RM;TS=HHHP;TSseq=C,C,C,-;CAnc=C...
	22      18685735        .       A       .       .       .       .;RM;TS=HHHP;TSseq=A,A,A,-;CAnc=A...
	22      18685736        .       A       .       .       .       .;RM;TS=HHHP;TSseq=A,A,A,-;CAnc=A...
# The problem is the ".;" at the beginning of field 8 (the INFO field).

# To fix these problems, I wrote a sed script (altai.sed) and a bash script (doaltai.sh), which 
# decompresses the file, filters it through altai.sed, and compressed the result.

# The .vcf files have two problems:
# Problem 1: The "LowQual" value, which shows up in the FILTER
# field, is not defined.
#
# Problem 2: Some INFO fields begin with ".;", which also generates
# a warning in bcftools.
#
# The code below filters all .vcf.gz files through a sed script, which adds 
# a definition of LowQual and replaces the string "\t.;" with "\t". In other 
# words, it deletes ".;" at the beginning of a field.

    ls AltaiNea.hg*.vcf.gz | xargs -P 20 -n 1 bash doaltai.sh

# After running this, I have files with names like xxx-fixed.vcf.gz, which bcftools
# will read without reporting errors.

# Get rid of original vcf files.
   ls *.vcf.gz | grep -v fixed | xargs rm

# I forgot to compress with bgzip, so..
echo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 X | xargs -P 12 -n 1 bash dobgzip.sh

# Index
ls *.vcf.bgz | xargs -P 20 -n 1 tabix

# Filter
echo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 X | xargs -P 10 -n 1 bash filter.sh

# Index
ls *.bcf | xargs -P 20 -n 1 tabix

# Generate data for analysis. Output looks like
# 22,20006558,G,G/G
# 22,20006574,G,A/A
# 22,20006992,A,C/C
# Columns are chr, pos, ref, alt, ancestral_allele, genotypes...
bcftools query -f '%CHROM\t%POS\t%REF\t%ALT\t%INFO/CAnc[\t%GT]\n' AltaiNea.bcf | daf > AltaiNea.daf
